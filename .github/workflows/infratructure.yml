name: Infrastructure Deployment

on:
  push:
    branches:
    - main
    paths:
    - 'infra/terraform/**'
    - 'infra/ansible/**'
  workflow_dispatch:


env:
  AWS_REGION: us-east-1
  TF_VERSION: 1.5.0

jobs:
  terraform-plan:
    name: Terraform Plan & Drift Detection
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.check_changes.outputs.has_changes }}
      plan_output: ${{ steps.plan.outputs.stdout }}

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Terraform Init
      working-directory: ./infra/terraform
      run: terraform init

    - name: Terraform Plan
      id: plan
      working-directory: ./infra/terraform
      run: |
        terraform plan -out=tfplan -no-color | tee plan_output.txt
        echo "stdout<<EOF" >> $GITHUB_OUTPUT
        cat plan_output.txt >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Check for Changes (Drift Detection)
      id: check_changes
      working-directory: ./infra/terraform
      run: |
        if grep -q "No changes" plan_output.txt; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "âœ… No infrastructure drift detected"
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "âš ï¸ Infrastructure changes detected!"
        fi

    - name: Upload Terraform Plan
      if: steps.check_changes.outputs.has_changes == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: tfplan
        path: infra/terraform/tfplan
        retention-days: 5

    - name: Upload Plan Output
      if: steps.check_changes.outputs.has_changes == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: plan-output
        path: infra/terraform/plan_output.txt
        retention-days: 5

  send-drift-notification:
    name: Send Drift Detection Email
    needs: terraform-plan
    if: needs.terraform-plan.outputs.has_changes == 'true'
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Download Plan Output
      uses: actions/download-artifact@v4
      with:
        name: plan-output

    - name: Prepare Email Body
      run: |
        cat > email_body.txt <<EOF
        âš ï¸ TERRAFORM DRIFT DETECTED âš ï¸

        Infrastructure changes have been detected in your TODO Application deployment.

        ğŸ“‹ Details:
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        Repository: ${{ github.repository }}
        Branch: ${{ github.ref_name }}
        Commit: ${{ github.sha }}
        Triggered by: ${{ github.actor }}
        Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

        ğŸ“Š Terraform Plan Output:
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        EOF
        cat plan_output.txt >> email_body.txt
        cat >> email_body.txt <<EOF

        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

        âš ï¸ ACTION REQUIRED:
        The deployment workflow is now paused and waiting for manual approval.

        ğŸ‘‰ To approve these changes and proceed with deployment:
           Visit: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
           Click "Review deployments" and approve the "production" environment

        ğŸ‘‰ To reject these changes:
           Simply close the workflow run or let it timeout

        â±ï¸ This approval request will expire in 1 hour.

        ğŸ” Security Note: Only authorized approvers can deploy these changes.
        EOF

    - name: Send Email Notification
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: 'âš ï¸ [ACTION REQUIRED] Terraform Drift Detected - padre.the.chickenkiller.com'
        to: ${{ secrets.NOTIFICATION_EMAIL }}
        from: 'DevOps CI/CD <${{ secrets.EMAIL_USERNAME }}>'
        body: file://email_body.txt
        priority: high

    - name: Post Comment on Commit (if push event)
      if: github.event_name == 'push'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.repos.createCommitComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            commit_sha: context.sha,
            body: 'âš ï¸ **Terraform Drift Detected**\n\nInfrastructure changes detected. Email sent to approvers.\n\n[View Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})'
          })

  wait-for-approval:
    name: Wait for Manual Approval
    needs: [ terraform-plan, send-drift-notification ]
    if: needs.terraform-plan.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://padre.the.chickenkiller.com

    steps:
    - name: Manual Approval Granted
      run: |
        echo "âœ… Manual approval granted by reviewer"
        echo "Proceeding with terraform apply..."

  terraform-apply:
    name: Apply Infrastructure Changes
    needs: [ terraform-plan, wait-for-approval ]
    if: needs.terraform-plan.outputs.has_changes == 'true'
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Download Terraform Plan
      uses: actions/download-artifact@v4
      with:
        name: tfplan
        path: infra/terraform/

    - name: Setup SSH Key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa

    - name: Terraform Init
      working-directory: ./infra/terraform
      run: terraform init

    - name: Terraform Apply
      working-directory: ./infra/terraform
      run: terraform apply tfplan

    - name: Send Success Email
      if: success()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: 'âœ… Infrastructure Deployment Successful - padre.the.chickenkiller.com'
        to: ${{ secrets.NOTIFICATION_EMAIL }}
        from: 'DevOps CI/CD <${{ secrets.EMAIL_USERNAME }}>'
        body: |
          âœ… INFRASTRUCTURE DEPLOYMENT SUCCESSFUL

          The infrastructure changes have been successfully applied.

          ğŸ“‹ Details:
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          Repository: ${{ github.repository }}
          Branch: ${{ github.ref_name }}
          Commit: ${{ github.sha }}
          Deployed by: ${{ github.actor }}
          Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ğŸŒ Application URL: https://padre.the.chickenkiller.com

          âœ¨ All services are now running with the updated infrastructure.

    - name: Send Failure Email
      if: failure()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: 'âŒ Infrastructure Deployment Failed - padre.the.chickenkiller.com'
        to: ${{ secrets.NOTIFICATION_EMAIL }}
        from: 'DevOps CI/CD <${{ secrets.EMAIL_USERNAME }}>'
        body: |
          âŒ INFRASTRUCTURE DEPLOYMENT FAILED

          The infrastructure deployment encountered an error.

          ğŸ“‹ Details:
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          Repository: ${{ github.repository }}
          Branch: ${{ github.ref_name }}
          Commit: ${{ github.sha }}
          Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          âš ï¸ ACTION REQUIRED:
          Please check the workflow logs for error details and take corrective action.

  no-changes-detected:
    name: No Changes - Skip Deployment
    needs: terraform-plan
    if: needs.terraform-plan.outputs.has_changes == 'false'
    runs-on: ubuntu-latest

    steps:
    - name: Log No Changes
      run: |
        echo "âœ… No infrastructure drift detected"
        echo "Terraform state matches desired configuration"
        echo "Skipping deployment"
