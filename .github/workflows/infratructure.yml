name: Infrastructure Deployment

on:
  push:
    branches:
    - main
    paths:
    - 'infra/terraform/**'
    - 'infra/ansible/**'
  workflow_dispatch:


env:
  AWS_REGION: us-east-1
  TF_VERSION: 1.5.0

jobs:
  terraform-plan:
    name: Terraform Plan & Drift Detection
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.check_changes.outputs.has_changes }}
      plan_exitcode: ${{ steps.plan.outputs.exitcode }}

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
        terraform_wrapper: false

    # Create SSH key from secret BEFORE terraform init
    - name: Setup SSH Key for Terraform
      run: |
        mkdir -p ${{ github.workspace }}/infra/terraform/.ssh
        echo "${{ secrets.SSH_PUBLIC_KEY }}" > ${{ github.workspace }}/infra/terraform/.ssh/devops_stage6.pub
        chmod 644 ${{ github.workspace }}/infra/terraform/.ssh/devops_stage6.pub

    - name: Terraform Init
      working-directory: ./infra/terraform
      run: terraform init

    - name: Terraform Plan
      id: plan
      working-directory: ./infra/terraform
      run: |
        set +e
        terraform plan -detailed-exitcode -out=tfplan -no-color 2>&1 | tee plan_output.txt
        PLAN_EXIT_CODE=${PIPESTATUS[0]}
        echo "exitcode=$PLAN_EXIT_CODE" >> $GITHUB_OUTPUT

        # Exit code 0 = no changes, 1 = error, 2 = changes detected
        if [ $PLAN_EXIT_CODE -eq 1 ]; then
          echo "âŒ Terraform plan failed with errors"
          exit 1
        fi

        exit 0

    - name: Check for Changes (Drift Detection)
      id: check_changes
      working-directory: ./infra/terraform
      run: |
        PLAN_EXIT_CODE=${{ steps.plan.outputs.exitcode }}

        if [ "$PLAN_EXIT_CODE" = "0" ]; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "âœ… No infrastructure drift detected"
        elif [ "$PLAN_EXIT_CODE" = "2" ]; then
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "âš ï¸ Infrastructure changes detected!"
        fi

    - name: Upload Terraform Plan
      if: steps.check_changes.outputs.has_changes == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: tfplan
        path: infra/terraform/tfplan
        retention-days: 5

    - name: Upload Plan Output
      if: steps.check_changes.outputs.has_changes == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: plan-output
        path: infra/terraform/plan_output.txt
        retention-days: 5

    - name: Upload SSH Key
      if: steps.check_changes.outputs.has_changes == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: ssh-key
        path: infra/terraform/.ssh/devops_stage6.pub
        retention-days: 1

  send-drift-notification:
    name: Send Drift Detection Email
    needs: terraform-plan
    if: needs.terraform-plan.outputs.has_changes == 'true'
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Download Plan Output
      uses: actions/download-artifact@v4
      with:
        name: plan-output

    - name: Prepare Email Body
      run: |
        cat > email_body.txt <<EOF
        âš ï¸ TERRAFORM DRIFT DETECTED âš ï¸

        Infrastructure changes have been detected in your TODO Application deployment.

        ğŸ“‹ Details:
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        Repository: ${{ github.repository }}
        Branch: ${{ github.ref_name }}
        Commit: ${{ github.sha }}
        Triggered by: ${{ github.actor }}
        Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

        ğŸ“Š Terraform Plan Output:
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        EOF
        cat plan_output.txt >> email_body.txt
        cat >> email_body.txt <<EOF

        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

        âš ï¸ ACTION REQUIRED:
        The deployment workflow is now paused and waiting for manual approval.

        ğŸ‘‰ To approve these changes and proceed with deployment:
           Visit: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
           Click "Review deployments" and approve the "production" environment

        ğŸ‘‰ To reject these changes:
           Simply close the workflow run or let it timeout

        â±ï¸ This approval request will expire in 1 hour.
        ğŸ” Security Note: Only authorized approvers can deploy these changes.
        EOF

    - name: Send Email Notification
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: 'âš ï¸ [ACTION REQUIRED] Terraform Drift Detected - padre.the.chickenkiller.com'
        to: ${{ secrets.NOTIFICATION_EMAIL }}
        from: 'DevOps CI/CD <${{ secrets.EMAIL_USERNAME }}>'
        body: file://email_body.txt
        priority: high

    - name: Post Comment on Commit (if push event)
      if: github.event_name == 'push'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.repos.createCommitComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            commit_sha: context.sha,
            body: 'âš ï¸ **Terraform Drift Detected**\n\nInfrastructure changes detected. Email sent to approvers.\n\n[View Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})'
          })

  wait-for-approval:
    name: Wait for Manual Approval
    needs: [ terraform-plan, send-drift-notification ]
    if: needs.terraform-plan.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://padre.the.chickenkiller.com
    timeout-minutes: 60

    steps:
    - name: Manual Approval Granted
      run: |
        echo "âœ… Manual approval granted by reviewer"
        echo "Proceeding with terraform apply..."

  terraform-apply:
    name: Apply Infrastructure Changes
    needs: [ terraform-plan, wait-for-approval ]
    if: needs.terraform-plan.outputs.has_changes == 'true'
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
        terraform_wrapper: false

    - name: Download Terraform Plan
      uses: actions/download-artifact@v4
      with:
        name: tfplan
        path: infra/terraform/

    - name: Download SSH Key
      uses: actions/download-artifact@v4
      with:
        name: ssh-key
        path: infra/terraform/.ssh/

    - name: Setup SSH Key for Deployment
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan github.com >> ~/.ssh/known_hosts

    - name: Terraform Init
      working-directory: ./infra/terraform
      run: terraform init

    - name: Terraform Apply
      working-directory: ./infra/terraform
      run: terraform apply -auto-approve tfplan

    - name: Get EC2 Instance Info
      id: ec2_info
      working-directory: ./infra/terraform
      run: |
        INSTANCE_IP=$(terraform output -raw instance_public_ip 2>/dev/null || echo "")
        INSTANCE_EXISTS=$(terraform output -raw instance_id 2>/dev/null || echo "")

        echo "instance_ip=$INSTANCE_IP" >> $GITHUB_OUTPUT
        echo "instance_exists=$INSTANCE_EXISTS" >> $GITHUB_OUTPUT

        if [ -n "$INSTANCE_EXISTS" ]; then
          echo "âœ… EC2 instance exists: $INSTANCE_EXISTS"
          echo "ğŸ“ Public IP: $INSTANCE_IP"
        else
          echo "âš ï¸ No EC2 instance found"
        fi

    - name: Upload Instance Info
      uses: actions/upload-artifact@v4
      with:
        name: ec2-info
        path: |
          infra/terraform/terraform.tfstate
        retention-days: 1

    - name: Send Success Email
      if: success()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: 'âœ… Infrastructure Deployment Successful - padre.the.chickenkiller.com'
        to: ${{ secrets.NOTIFICATION_EMAIL }}
        from: 'DevOps CI/CD <${{ secrets.EMAIL_USERNAME }}>'
        body: |
          âœ… INFRASTRUCTURE DEPLOYMENT SUCCESSFUL

          The infrastructure changes have been successfully applied.

          ğŸ“‹ Details:
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          Repository: ${{ github.repository }}
          Branch: ${{ github.ref_name }}
          Commit: ${{ github.sha }}
          Deployed by: ${{ github.actor }}
          Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ğŸŒ Application URL: https://padre.the.chickenkiller.com

          âœ¨ Infrastructure is ready. Ansible configuration will run next if server exists.

    - name: Send Failure Email
      if: failure()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: 'âŒ Infrastructure Deployment Failed - padre.the.chickenkiller.com'
        to: ${{ secrets.NOTIFICATION_EMAIL }}
        from: 'DevOps CI/CD <${{ secrets.EMAIL_USERNAME }}>'
        body: |
          âŒ INFRASTRUCTURE DEPLOYMENT FAILED

          The infrastructure deployment encountered an error.

          ğŸ“‹ Details:
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          Repository: ${{ github.repository }}
          Branch: ${{ github.ref_name }}
          Commit: ${{ github.sha }}
          Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          âš ï¸ ACTION REQUIRED:
          Please check the workflow logs for error details and take corrective action.

  ansible-configure:
    name: Run Ansible Configuration
    needs: [ terraform-apply ]
    if: success()
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Download Instance Info
      uses: actions/download-artifact@v4
      with:
        name: ec2-info

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
        terraform_wrapper: false

    - name: Check if Server Exists
      id: check_server
      working-directory: ./infra/terraform
      run: |
        terraform init

        INSTANCE_ID=$(terraform output -raw instance_id 2>/dev/null || echo "")
        INSTANCE_IP=$(terraform output -raw instance_public_ip 2>/dev/null || echo "")

        if [ -n "$INSTANCE_ID" ] && [ "$INSTANCE_ID" != "" ]; then
          echo "server_exists=true" >> $GITHUB_OUTPUT
          echo "instance_ip=$INSTANCE_IP" >> $GITHUB_OUTPUT
          echo "âœ… Server exists: $INSTANCE_ID at $INSTANCE_IP"
        else
          echo "server_exists=false" >> $GITHUB_OUTPUT
          echo "âš ï¸ No server found - skipping Ansible"
        fi

    - name: Setup SSH Key for Ansible
      if: steps.check_server.outputs.server_exists == 'true'
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa

        # Add the instance to known_hosts
        ssh-keyscan -H ${{ steps.check_server.outputs.instance_ip }} >> ~/.ssh/known_hosts 2>/dev/null || true

    - name: Install Ansible
      if: steps.check_server.outputs.server_exists == 'true'
      run: |
        sudo apt-get update
        sudo apt-get install -y ansible

    - name: Wait for SSH to be Ready
      if: steps.check_server.outputs.server_exists == 'true'
      run: |
        echo "â³ Waiting for SSH to be ready on ${{ steps.check_server.outputs.instance_ip }}..."
        for i in {1..30}; do
          if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 ubuntu@${{ steps.check_server.outputs.instance_ip }} "echo 'SSH Ready'" 2>/dev/null; then
            echo "âœ… SSH is ready!"
            exit 0
          fi
          echo "Attempt $i/30: SSH not ready yet, waiting 10s..."
          sleep 10
        done
        echo "âŒ SSH connection timeout"
        exit 1

    - name: Run Ansible Playbook
      if: steps.check_server.outputs.server_exists == 'true'
      working-directory: ./infra/ansible
      run: |
        echo "ğŸš€ Running Ansible configuration..."
        ansible-playbook -i inventory/hosts.ini playbook.yml -v

    - name: Ansible Skipped (No Server)
      if: steps.check_server.outputs.server_exists != 'true'
      run: |
        echo "â­ï¸ Ansible skipped - no server exists"
        echo "This is normal if infrastructure was destroyed or not yet created"

    - name: Send Ansible Success Email
      if: steps.check_server.outputs.server_exists == 'true' && success()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: 'âœ… Ansible Configuration Successful - padre.the.chickenkiller.com'
        to: ${{ secrets.NOTIFICATION_EMAIL }}
        from: 'DevOps CI/CD <${{ secrets.EMAIL_USERNAME }}>'
        body: |
          âœ… ANSIBLE CONFIGURATION SUCCESSFUL

          Server configuration has been applied successfully.

          ğŸ“‹ Details:
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          Repository: ${{ github.repository }}
          Branch: ${{ github.ref_name }}
          Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          Instance IP: ${{ steps.check_server.outputs.instance_ip }}

          ğŸŒ Application URL: https://padre.the.chickenkiller.com

          âœ¨ Infrastructure is fully configured and ready for application deployment.

    - name: Send Ansible Failure Email
      if: steps.check_server.outputs.server_exists == 'true' && failure()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: 'âŒ Ansible Configuration Failed - padre.the.chickenkiller.com'
        to: ${{ secrets.NOTIFICATION_EMAIL }}
        from: 'DevOps CI/CD <${{ secrets.EMAIL_USERNAME }}>'
        body: |
          âŒ ANSIBLE CONFIGURATION FAILED

          Server configuration encountered an error.

          ğŸ“‹ Details:
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          Repository: ${{ github.repository }}
          Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          âš ï¸ ACTION REQUIRED:
          Please check the workflow logs for error details.

  auto-apply-no-drift:
    name: Auto-Apply (No Drift Detected)
    needs: terraform-plan
    if: needs.terraform-plan.outputs.has_changes == 'false'
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
        terraform_wrapper: false

    - name: Setup SSH Key for Terraform
      run: |
        mkdir -p ${{ github.workspace }}/infra/terraform/.ssh
        echo "${{ secrets.SSH_PUBLIC_KEY }}" > ${{ github.workspace }}/infra/terraform/.ssh/devops_stage6.pub
        chmod 644 ${{ github.workspace }}/infra/terraform/.ssh/devops_stage6.pub

    - name: Terraform Init
      working-directory: ./infra/terraform
      run: terraform init

    - name: Terraform Apply (Auto)
      working-directory: ./infra/terraform
      run: |
        echo "âœ… No infrastructure drift detected"
        echo "Terraform state matches desired configuration"
        terraform apply -auto-approve

    - name: Check if Server Exists
      id: check_server
      working-directory: ./infra/terraform
      run: |
        INSTANCE_ID=$(terraform output -raw instance_id 2>/dev/null || echo "")
        INSTANCE_IP=$(terraform output -raw instance_public_ip 2>/dev/null || echo "")

        if [ -n "$INSTANCE_ID" ] && [ "$INSTANCE_ID" != "" ]; then
          echo "server_exists=true" >> $GITHUB_OUTPUT
          echo "instance_ip=$INSTANCE_IP" >> $GITHUB_OUTPUT
        else
          echo "server_exists=false" >> $GITHUB_OUTPUT
        fi

    - name: Setup SSH Key for Ansible
      if: steps.check_server.outputs.server_exists == 'true'
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ steps.check_server.outputs.instance_ip }} >> ~/.ssh/known_hosts 2>/dev/null || true

    - name: Install Ansible
      if: steps.check_server.outputs.server_exists == 'true'
      run: |
        sudo apt-get update
        sudo apt-get install -y ansible

    - name: Run Ansible Playbook
      if: steps.check_server.outputs.server_exists == 'true'
      working-directory: ./infra/ansible
      run: |
        echo "ğŸš€ Running Ansible configuration (no drift path)..."
        ansible-playbook -i inventory/hosts.ini playbook.yml -v

    - name: Send Success Email
      if: success()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: 'âœ… Infrastructure Auto-Applied (No Drift) - padre.the.chickenkiller.com'
        to: ${{ secrets.NOTIFICATION_EMAIL }}
        from: 'DevOps CI/CD <${{ secrets.EMAIL_USERNAME }}>'
        body: |
          âœ… INFRASTRUCTURE AUTO-APPLIED

          No drift detected. Infrastructure and configuration automatically applied.

          ğŸ“‹ Details:
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          Repository: ${{ github.repository }}
          Branch: ${{ github.ref_name }}
          Commit: ${{ github.sha }}
          Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ğŸŒ Application URL: https://padre.the.chickenkiller.com
