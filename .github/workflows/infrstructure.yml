name: Infrastructure Deployment

on:
  push:
    branches: [ main ]
    paths:
    - 'infra/terraform/**'
    - 'infra/ansible/**'
  workflow_dispatch:


env:
  AWS_REGION: us-east-1
  TF_VERSION: 1.6.0

jobs:
  terraform-plan:
    name: Terraform Plan & Drift Detection
    runs-on: ubuntu-latest
    outputs:
      has_drift: ${{ steps.drift-check.outputs.has_drift }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Terraform Init
      working-directory: infra/terraform
      run: terraform init

    - name: Terraform Plan
      id: plan
      working-directory: infra/terraform
      run: |
        terraform plan -out=tfplan -no-color | tee plan_output.txt
        echo "plan_exitcode=$?" >> $GITHUB_OUTPUT

    - name: Check for Drift
      id: drift-check
      working-directory: infra/terraform
      run: |
        if grep -q "No changes" plan_output.txt; then
          echo "has_drift=false" >> $GITHUB_OUTPUT
          echo "‚úÖ No drift detected"
        else
          echo "has_drift=true" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è Drift detected!"
        fi

    - name: Upload Plan
      if: steps.drift-check.outputs.has_drift == 'true'
      uses: actions/upload-artifact@v3
      with:
        name: terraform-plan
        path: infra/terraform/tfplan

    - name: Send Drift Detection Email
      if: steps.drift-check.outputs.has_drift == 'true'
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: 'üö® Infrastructure Drift Detected - TODO App'
        to: ${{ secrets.ALERT_EMAIL }}
        from: DevOps Bot <${{ secrets.EMAIL_USERNAME }}>
        body: |
          Drift has been detected in the TODO Application infrastructure.

          Repository: ${{ github.repository }}
          Branch: ${{ github.ref_name }}
          Commit: ${{ github.sha }}
          Triggered by: ${{ github.actor }}

          Please review the changes in the GitHub Actions workflow:
          ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          Manual approval is required before applying changes.
        priority: high

  await-approval:
    name: Await Manual Approval
    runs-on: ubuntu-latest
    needs: terraform-plan
    if: needs.terraform-plan.outputs.has_drift == 'true'
    environment: production # Requires manual approval in GitHub Settings

    steps:
    - name: Manual Approval Gate
      run: echo "‚úÖ Approved by ${{ github.actor }}"

  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: [ terraform-plan, await-approval ]
    if: always() && (needs.await-approval.result == 'success' || needs.terraform-plan.outputs.has_drift == 'false')

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Terraform Init
      working-directory: infra/terraform
      run: terraform init

    - name: Download Plan (if drift existed)
      if: needs.terraform-plan.outputs.has_drift == 'true'
      uses: actions/download-artifact@v3
      with:
        name: terraform-plan
        path: infra/terraform/

    - name: Terraform Apply
      working-directory: infra/terraform
      run: |
        if [ "${{ needs.terraform-plan.outputs.has_drift }}" == "true" ]; then
          terraform apply tfplan
        else
          terraform apply -auto-approve
        fi

    - name: Send Success Email
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: '‚úÖ Infrastructure Applied Successfully - TODO App'
        to: ${{ secrets.ALERT_EMAIL }}
        from: DevOps Bot <${{ secrets.EMAIL_USERNAME }}>
        body: |
          Infrastructure changes have been successfully applied.

          Repository: ${{ github.repository }}
          Branch: ${{ github.ref_name }}
          Commit: ${{ github.sha }}
          Applied by: ${{ github.actor }}

          View details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
